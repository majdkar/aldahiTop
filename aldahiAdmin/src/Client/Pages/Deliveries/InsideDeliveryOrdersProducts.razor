@using System.Globalization
@using FirstCall.Application.Features.OrderProducts.Commands.AddEdit
@attribute [Authorize(Policy = Permissions.DeliveryOrders.View)]
@inject Microsoft.Extensions.Localization.IStringLocalizer<DeliveryOrders> _localizer


<style>
    .mud-table-container {
        overflow: auto;
    }
    td{
        padding:1px !important;
    }
    .mud-table-dense * .mud-table-row .mud-table-cell{
            padding-inline-end: 0px !important;
    }

    .mud-input-control > .mud-input-control-input-container > div.mud-input.mud-input-text{
        margin-top: -7px !important;
    }

    .mud-popover-custom {
        z-index: 5000 !important;
        width: 100% !important;
    }
 /*   .mud-table-sort-label{
       font-size:smaller !important;
   } */
</style>

@*<HeroTitle Title="@_localizer["Order Details"]" />
*@@if (!_loaded)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{


    <MudTable Hover="true"
              Elevation="2"
              Items="Charges"
              ReadOnly="!_canCreateLeaseCharges"
              Loading="!_loaded"
              Dense="true"
              Bordered="@_bordered"
              Striped="@_striped"
              RowEditCommit="@(async (e) => await ItemHasBeenCommitted(e))"
              @bind-LeaseCharge="_LeaseCharge">

        <ColGroup>
            <col style="width: 45%;" />
            <col style="width: 15%;" />
            <col style="width: 15%;" />
            <col style="width: 15%;" />
            <col style="width: 10%;" />
        </ColGroup>

        <HeaderContent>
            <MudTh Style="text-align:center;color: black;font-weight: bold;">
                <MudTableSortLabel SortBy="new Func<AddEditDeliveryOrderProductCommand, object>(x => x.ProductId)">
                    @_localizer["ProductNameAr"]
                </MudTableSortLabel>
            </MudTh>
            <MudTh Style="text-align:center;color: black;font-weight: bold;">
                <MudTableSortLabel SortBy="new Func<AddEditDeliveryOrderProductCommand, object>(x => x.Quantity)">
                    @_localizer["Quantity"]
                </MudTableSortLabel>
            </MudTh>
            <MudTh Style="text-align:center;color: black;font-weight: bold;">
                <MudTableSortLabel SortBy="new Func<AddEditDeliveryOrderProductCommand, object>(x => x.UnitPrice)">
                    @_localizer["UnitPrice"]
                </MudTableSortLabel>
            </MudTh>
            <MudTh Style="text-align:center;color: black;font-weight: bold;">
                <MudTableSortLabel SortBy="new Func<AddEditDeliveryOrderProductCommand, object>(x => x.TotalPrice)">
                    @_localizer["TotalPrice"]
                </MudTableSortLabel>
            </MudTh>
            <MudTh Style="text-align:center;color: black;font-weight: bold;">
                @_localizer["Actions"]
            </MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Product" Style="position:absolute; text-align:center;">
                @context.ProductId
            </MudTd>
            <MudTd DataLabel="Quantity" Style="text-align:center;">
                @context.Quantity
            </MudTd>
            <MudTd DataLabel="UnitPrice" Style="text-align:center;">
                @context.UnitPrice
            </MudTd>
            <MudTd DataLabel="TotalPrice" Style="text-align:center;">
                @context.TotalPrice
            </MudTd>
            <MudTd DataLabel="Actions" Style="text-align:center;">
                @if (_canCreateLeaseCharges)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   Variant="Variant.Filled"
                                   @onclick="@(() => Delete(context))" />
                }
            </MudTd>
        </RowTemplate>

        <RowEditingTemplate>
            <MudTd DataLabel="Product" Style="position:absolute; text-align:center;">
                <MudAutocomplete T="int"
                                 Value="@context.ProductId"
                                 ResetValueOnEmptyText="true"
                                 SearchFunc="@SearchProducts"
                                 ToStringFunc="ProductToString"
                                 Dense="true"
                                 PopoverClass="mud-popover-custom"
                                 Class="w-100" />
            </MudTd>

            <MudTd DataLabel="Quantity" Style="text-align:center;">
                <MudTextField @bind-Value="@context.Quantity"
                              Dense="true"
                              Format="F2"
                              Culture="@CultureInfo.InvariantCulture"
                              Class="w-100"
                              Style="text-align:center;color: green;font-weight: bold;" />
            </MudTd>

            <MudTd DataLabel="UnitPrice" Style="text-align:center;">
                <MudTextField @bind-Value="@context.UnitPrice"
                              Dense="true"
                              Class="w-100"
                              Style="text-align:center;color: green;font-weight: bold;" />
            </MudTd>

            <MudTd DataLabel="TotalPrice" Style="text-align:center;">
                <MudTextField ReadOnly Value="@((context.Quantity * context.UnitPrice))"
                              Dense="true"
                              Class="w-100"
                              Style="text-align:center;color: green;font-weight: bold;" />
            </MudTd>

            <MudTd DataLabel="Actions" Style="text-align:center;">
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               Size="Size.Small"
                               Variant="Variant.Filled"
                               @onclick="@(() => Delete(context))" />
            </MudTd>
        </RowEditingTemplate>

        <FooterContent>
            <MudTd ColSpan="5" Style="text-align:left;">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           DisableElevation="true"
                           StartIcon="@Icons.Material.Filled.Add"
                           @onclick="InvokeModal">
                    @_localizer["Add Another Product"]
                </MudButton>
            </MudTd>
        </FooterContent>
    </MudTable>

}